#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ê³µí†µ í•¨ìˆ˜ ëª¨ë“ˆ

ë‹¤ì–‘í•œ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê³µí†µ í•¨ìˆ˜ë“¤ì„ ì œê³µí•©ë‹ˆë‹¤.

ì‘ì„±ì¼: 2025-10-16
"""

import pandas as pd
import ast
from pathlib import Path
from datetime import datetime


# ============================================================================
# ìƒìˆ˜ ì •ì˜
# ============================================================================

# ì ìˆ˜ í•­ëª© ì •ì˜
SCORE_COLUMNS = ['ì¡´ì¤‘ë°°ë ¤', 'ì •ë³´ê³µìœ ', 'ëª…í™•ì²˜ë¦¬', 'íƒœë„ê°œì„ ', 'ì „ë°˜ë§Œì¡±', 'ì¢…í•©ì ìˆ˜']

# ì—‘ì…€ ì»¬ëŸ¼ ì •ì˜
EXCEL_COLUMNS = [
    'response_id', 'ì„¤ë¬¸ì‹œí–‰ì—°ë„', 'í‰ê°€_ë¶€ì„œëª…', 'í‰ê°€_ë¶€ì„œëª…_ì›ë³¸', 'í‰ê°€_Unitëª…', 'í‰ê°€_ë¶€ë¬¸',
    'í”¼í‰ê°€ëŒ€ìƒ ë¶€ì„œëª…', 'í”¼í‰ê°€ëŒ€ìƒ_ë¶€ì„œëª…_ì›ë³¸', 'í”¼í‰ê°€ëŒ€ìƒ UNITëª…', 'í”¼í‰ê°€ëŒ€ìƒ ë¶€ë¬¸',
    'â—‹â—‹ì€ íƒ€ ë¶€ì„œì˜ ì…ì¥ì„ ì¡´ì¤‘í•˜ê³  ë°°ë ¤í•˜ì—¬ í˜‘ë ¥í•´ì£¼ë©°. í˜‘ì—… ê´€ë ¨ ì˜ê²¬ì„ ê²½ì²­í•´ì¤€ë‹¤.',
    'â—‹â—‹ì€ ì—…ë¬´ìƒ í•„ìš”í•œ ì •ë³´ì— ëŒ€í•´ ê³µìœ ê°€ ì˜ ì´ë£¨ì–´ì§„ë‹¤.',
    'â—‹â—‹ì€ ì—…ë¬´ì— ëŒ€í•œ ëª…í™•í•œ ë‹´ë‹¹ìê°€ ìˆê³  ì—…ë¬´ë¥¼ ì¼ê´€ì„±ìˆê²Œ ì²˜ë¦¬í•´ì¤€ë‹¤.',
    'â—‹â—‹ì€ ì´ì „ë³´ë‹¤ ì—…ë¬´ í˜‘ë ¥ì— ëŒ€í•œ íƒœë„ë‚˜ ì˜ì§€ê°€ ê°œì„ ë˜ê³  ìˆë‹¤.',
    'ì „ë°˜ì ìœ¼ë¡œ â—‹â—‹ê³¼ì˜ í˜‘ì—…ì— ëŒ€í•´ ë§Œì¡±í•œë‹¤.',
    'ì¢…í•©ì ìˆ˜', 'ê·¹ë‹¨ê°’', 'ê²°ì¸¡ê°’', 'í˜‘ì—… ìœ í˜•', 'í˜‘ì—… í›„ê¸°', 'ì •ì œëœ_í…ìŠ¤íŠ¸',
    'ë¹„ì‹ë³„_ì²˜ë¦¬', 'ê°ì •_ë¶„ë¥˜', 'ê°ì •_ê°•ë„_ì ìˆ˜', 'í•µì‹¬_í‚¤ì›Œë“œ', 'ì˜ë£Œ_ë§¥ë½', 'ì‹ ë¢°ë„_ì ìˆ˜'
]

# ì»¬ëŸ¼ëª… ë§¤í•‘
COLUMN_MAPPING = {
    'ì„¤ë¬¸ì‹œí–‰ì—°ë„': 'ì„¤ë¬¸ì‹œí–‰ì—°ë„',
    'í‰ê°€_ë¶€ì„œëª…': 'í‰ê°€ë¶€ì„œ',
    'í‰ê°€_ë¶€ë¬¸': 'í‰ê°€ë¶€ë¬¸',
    'í”¼í‰ê°€ëŒ€ìƒ ë¶€ì„œëª…': 'í”¼í‰ê°€ë¶€ì„œ',
    'í”¼í‰ê°€ëŒ€ìƒ ë¶€ë¬¸': 'í”¼í‰ê°€ë¶€ë¬¸',
    'í”¼í‰ê°€ëŒ€ìƒ UNITëª…': 'í”¼í‰ê°€Unit',
    'â—‹â—‹ì€ íƒ€ ë¶€ì„œì˜ ì…ì¥ì„ ì¡´ì¤‘í•˜ê³  ë°°ë ¤í•˜ì—¬ í˜‘ë ¥í•´ì£¼ë©°. í˜‘ì—… ê´€ë ¨ ì˜ê²¬ì„ ê²½ì²­í•´ì¤€ë‹¤.': 'ì¡´ì¤‘ë°°ë ¤',
    'â—‹â—‹ì€ ì—…ë¬´ìƒ í•„ìš”í•œ ì •ë³´ì— ëŒ€í•´ ê³µìœ ê°€ ì˜ ì´ë£¨ì–´ì§„ë‹¤.': 'ì •ë³´ê³µìœ ',
    'â—‹â—‹ì€ ì—…ë¬´ì— ëŒ€í•œ ëª…í™•í•œ ë‹´ë‹¹ìê°€ ìˆê³  ì—…ë¬´ë¥¼ ì¼ê´€ì„±ìˆê²Œ ì²˜ë¦¬í•´ì¤€ë‹¤.': 'ëª…í™•ì²˜ë¦¬',
    'â—‹â—‹ì€ ì´ì „ë³´ë‹¤ ì—…ë¬´ í˜‘ë ¥ì— ëŒ€í•œ íƒœë„ë‚˜ ì˜ì§€ê°€ ê°œì„ ë˜ê³  ìˆë‹¤.': 'íƒœë„ê°œì„ ',
    'ì „ë°˜ì ìœ¼ë¡œ â—‹â—‹ê³¼ì˜ í˜‘ì—…ì— ëŒ€í•´ ë§Œì¡±í•œë‹¤.': 'ì „ë°˜ë§Œì¡±',
    'ì¢…í•©ì ìˆ˜': 'ì¢…í•©ì ìˆ˜',
    'í˜‘ì—… í›„ê¸°': 'í˜‘ì—…í›„ê¸°'
}

# í•„í„°ë§ ì„¤ì •
FILL_NA_COLUMNS = ['í”¼í‰ê°€ë¶€ë¬¸', 'í”¼í‰ê°€ë¶€ì„œ', 'í”¼í‰ê°€Unit', 'ì •ì œëœ_í…ìŠ¤íŠ¸']
EXCLUDE_DEPARTMENTS = ['ë¯¸ë¶„ë¥˜', 'ìœ¤ë¦¬ê²½ì˜ì‹¤']
EXCLUDE_TEAMS = ['ë‚´ë¶„ë¹„ì™¸ê³¼']


# ============================================================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ============================================================================

def get_latest_text_processor_file():
    """
    rawdata í´ë”ì—ì„œ ê°€ì¥ ìµœì‹ ì˜ text_processor_ê²°ê³¼ íŒŒì¼ì„ ì°¾ì•„ ë°˜í™˜í•©ë‹ˆë‹¤.

    Returns:
        str: ê°€ì¥ ìµœì‹  íŒŒì¼ì˜ ê²½ë¡œ
    """
    rawdata_path = Path("rawdata")
    pattern = "2. text_processor_ê²°ê³¼_*.xlsx"

    # _partial.xlsx íŒŒì¼ì€ ì œì™¸í•˜ê³  ê²€ìƒ‰
    files = [f for f in rawdata_path.glob(pattern) if not f.name.endswith('_partial.xlsx')]

    if not files:
        print(f"âš ï¸  '{pattern}' íŒ¨í„´ì˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return "rawdata/2. text_processor_ê²°ê³¼_20251013_093925.xlsx"  # ê¸°ë³¸ê°’

    # íŒŒì¼ëª…ì—ì„œ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì¶”ì¶œí•˜ì—¬ ìµœì‹  íŒŒì¼ ì„ íƒ
    if len(files) > 1:
        latest_file = max(files, key=lambda f: f.stat().st_mtime)
        print(f"ğŸ“ ìµœì‹  ë°ì´í„° íŒŒì¼ ìë™ ì„ íƒ: {latest_file.name}")
        return str(latest_file)
    else:
        return str(files[0])


def log_message(message, level="INFO"):
    """
    ì‹¤í–‰ ê³¼ì •ì„ ì¶”ì í•˜ê¸° ìœ„í•œ ë¡œê·¸ ë©”ì‹œì§€ ì¶œë ¥

    Args:
        message (str): ì¶œë ¥í•  ë©”ì‹œì§€
        level (str): ë¡œê·¸ ë ˆë²¨ ("INFO", "WARNING", "ERROR")
    """
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    icon = {"INFO": "â„¹ï¸", "WARNING": "âš ï¸", "ERROR": "âŒ"}.get(level, "ğŸ“")
    print(f"[{timestamp}] {icon} {level}: {message}")


def safe_literal_eval(s):
    """
    ë¬¸ìì—´ì„ ì•ˆì „í•˜ê²Œ íŒŒì´ì¬ ë¦¬í„°ëŸ´(ë¦¬ìŠ¤íŠ¸)ë¡œ ë³€í™˜

    Args:
        s: ë³€í™˜í•  ë¬¸ìì—´ (ì˜ˆ: "['í‚¤ì›Œë“œ1', 'í‚¤ì›Œë“œ2']")

    Returns:
        list: ë³€í™˜ëœ ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” ë¹ˆ ë¦¬ìŠ¤íŠ¸
    """
    if isinstance(s, str) and s.startswith('[') and s.endswith(']'):
        try:
            return ast.literal_eval(s)
        except (ValueError, SyntaxError):
            return []
    return []


# ============================================================================
# ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬ í•¨ìˆ˜
# ============================================================================

def load_data(file_path):
    """
    ì—‘ì…€ íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ê¸°ë³¸ ì „ì²˜ë¦¬ ìˆ˜í–‰

    Args:
        file_path (str): ì—‘ì…€ íŒŒì¼ ê²½ë¡œ

    Returns:
        pd.DataFrame: ë¡œë“œëœ ë°ì´í„°í”„ë ˆì„
    """
    # ì—‘ì…€ íŒŒì¼ ë¡œë“œ
    df = pd.read_excel(file_path)

    # ì»¬ëŸ¼ëª… ì„¤ì •
    df.columns = EXCEL_COLUMNS

    # ì»¬ëŸ¼ëª… ë§¤í•‘
    df = df.rename(columns=COLUMN_MAPPING)

    return df


def preprocess_data_types(df, split_2025_period=False):
    """
    ë°ì´í„° íƒ€ì… ë³€í™˜ ë° ê¸°ë³¸ ì „ì²˜ë¦¬

    Args:
        df (pd.DataFrame): ì›ë³¸ ë°ì´í„°í”„ë ˆì„
        split_2025_period (bool): Trueì´ë©´ 2025ë…„ì„ ìƒí•˜ë°˜ê¸°ë¡œ ë¶„ë¦¬

    Returns:
        pd.DataFrame: íƒ€ì… ë³€í™˜ëœ ë°ì´í„°í”„ë ˆì„
    """
    # ì„¤ë¬¸ì‹œí–‰ì—°ë„ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
    df['ì„¤ë¬¸ì‹œí–‰ì—°ë„'] = df['ì„¤ë¬¸ì‹œí–‰ì—°ë„'].astype(str)

    # response_idì—ì„œ ì—°ë„_ë°˜ê¸° ì •ë³´ ì¶”ì¶œ
    def parse_period_from_response_id(response_id):
        """
        response_idì—ì„œ ì—°ë„ì™€ ë°˜ê¸°ë¥¼ ì¶”ì¶œí•˜ì—¬ ê¸°ê°„ í‘œì‹œ ìƒì„±
        """
        try:
            parts = str(response_id).split('_')
            if len(parts) >= 2:
                year = parts[0]
                period = parts[1]

                if split_2025_period and year == "2025":
                    period_name = "ìƒë°˜ê¸°" if period == "1" else "í•˜ë°˜ê¸°"
                    return f"{year}ë…„ {period_name}"
                else:
                    return f"{year}ë…„"
            return str(response_id)
        except:
            return str(response_id)

    # ê¸°ê°„_í‘œì‹œ ì»¬ëŸ¼ ìƒì„±
    if 'response_id' in df.columns:
        df['ê¸°ê°„_í‘œì‹œ'] = df['response_id'].apply(parse_period_from_response_id)
    else:
        df['ê¸°ê°„_í‘œì‹œ'] = df['ì„¤ë¬¸ì‹œí–‰ì—°ë„']

    # ì ìˆ˜ ì»¬ëŸ¼ë“¤ì„ ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜
    for col in SCORE_COLUMNS:
        if col in df.columns:
            df[col] = pd.to_numeric(df[col], errors='coerce')

    # í•µì‹¬ í‚¤ì›Œë“œ ì»¬ëŸ¼ ì „ì²˜ë¦¬
    if 'í•µì‹¬_í‚¤ì›Œë“œ' in df.columns:
        df['í•µì‹¬_í‚¤ì›Œë“œ'] = df['í•µì‹¬_í‚¤ì›Œë“œ'].apply(safe_literal_eval)

    return df


def clean_data(df):
    """
    ë°ì´í„° ì •ì œ ë° í’ˆì§ˆ ê´€ë¦¬

    Args:
        df (pd.DataFrame): ì „ì²˜ë¦¬ëœ ë°ì´í„°í”„ë ˆì„

    Returns:
        pd.DataFrame: ì •ì œëœ ë°ì´í„°í”„ë ˆì„
    """
    # ë¶€ë¬¸ ê¸°ì¤€ ì œì™¸
    for exclude_dept in EXCLUDE_DEPARTMENTS:
        condition = (df['í‰ê°€ë¶€ë¬¸'] != exclude_dept) & (df['í”¼í‰ê°€ë¶€ë¬¸'] != exclude_dept)
        df = df[condition]

    # ë¶€ì„œ ê¸°ì¤€ ì œì™¸
    for exclude_team in EXCLUDE_TEAMS:
        condition = (df['í‰ê°€ë¶€ì„œ'] != exclude_team) & (df['í”¼í‰ê°€ë¶€ì„œ'] != exclude_team)
        df = df[condition]

    # ì¢…í•©ì ìˆ˜ ê²°ì¸¡ê°’ ì œê±°
    df = df.dropna(subset=['ì¢…í•©ì ìˆ˜'])

    # ê²°ì¸¡ê°’ ì²˜ë¦¬
    for col in FILL_NA_COLUMNS:
        if col in df.columns:
            df[col] = df[col].fillna('N/A')

    return df
